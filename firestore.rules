rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);
      
      // Users can update their own profile (but not change role)
      allow update: if isOwner(userId) 
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
      
      // Users can be created during sign-up
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.role == 'traveler';
    }
    
    // Bookings collection
    match /bookings/{bookingId} {
      // Travelers can read their own bookings
      // Owners can read bookings for their properties
      allow read: if isAuthenticated() 
        && (resource.data.travelerId == request.auth.uid 
            || resource.data.ownerId == request.auth.uid);
      
      // Travelers can create bookings
      allow create: if isAuthenticated()
        && request.resource.data.travelerId == request.auth.uid
        && request.resource.data.status == 'PENDING_APPROVAL';
      
      // Owners can update status (approve/reject)
      // Travelers can update status (confirm payment)
      allow update: if isAuthenticated()
        && (
          // Owner approving or rejecting
          (resource.data.ownerId == request.auth.uid 
           && resource.data.status == 'PENDING_APPROVAL'
           && request.resource.data.status in ['AWAITING_PAYMENT', 'CANCELLED'])
          ||
          // Traveler confirming payment
          (resource.data.travelerId == request.auth.uid 
           && resource.data.status == 'AWAITING_PAYMENT'
           && request.resource.data.status == 'CONFIRMED')
        );
      
      // No one can delete bookings
      allow delete: if false;
    }
  }
}
